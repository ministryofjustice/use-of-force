version: '3.1'
services:

  oauth-server:
    image: mojdigitalstudio/nomis-oauth2-server:latest
    networks:
      - hmpps
    container_name: oauth-server
    ports:
      - "9090:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/auth/health"]
    environment:
      - SPRING_PROFILES_ACTIVE=dev

  elite2-api:
    image: mojdigitalstudio/elite2-api:latest
    networks:
      - hmpps
    container_name: elite2-api
    depends_on:
      - oauth-server
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
    environment:
      - SPRING_PROFILES_ACTIVE=nomis-hsqldb

  use-of-force-db:
    image: postgres
    networks:
      - hmpps
    container_name: use-of-force-db
    restart: always
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_PASSWORD=use-of-force
      - POSTGRES_USER=use-of-force
      - POSTGRES_DB=use-of-force

  use-of-force-redis:
    image: 'bitnami/redis:5.0'
    networks:
      - hmpps
    environment:
      - ALLOW_EMPTY_PASSWORD=yes
    ports:
      - '6379:6379'

  use-of-force:
    image: mojdigitalstudio/use-of-force:latest
    networks:
      - hmpps
    depends_on:
      - use-of-force-db
      - use-of-force-redis
      - oauth-server
      - elite2-api
    ports:
      - "3000:3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
    environment:
      - PORT=3000
      - DB_USER=use-of-force
      - DB_PASS=use-of-force
      - DB_SERVER=use-of-force-db
      - DB_NAME=use-of-force
      - DB_SSL_ENABLED=no
      - NOMIS_AUTH_URL=http://oauth-server:8080/auth
      - NOMIS_AUTH_EXTERNAL_URL=http://localhost:9090/auth
      - ELITE2API_ENDPOINT_URL=http://elite2-api:8080
      - NODE_ENV=development

networks:
  hmpps:
