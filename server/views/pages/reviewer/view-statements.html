{% extends "../../partials/prisonerBannerLayout.njk" %}
{% from "govuk/components/button/macro.njk" import govukButton %} 
{% from "govuk/components/table/macro.njk" import govukTable %}
{%- from "moj/components/sub-navigation/macro.njk" import mojSubNavigation -%}
{% from  "../../macros.njk" import overdueBadge %}   
{% from  "../../macros.njk" import removalRequestedBadge %}    
{% import "../reportDetailMacro.njk" as reportDetail %} 
{% set pageTitle = 'Use of force incident' %}

{% block beforeContent %}
  {% include "../../partials/breadcrumbs.njk" %}
  {{ super() }}
{% endblock %}

{% block content %}
{% if featureFlagReportEditingEnabled %}
<div class="govuk-body">
  <div class="govuk-grid-row no-print negative-margin-top-7">     
    <div class="govuk-grid-column-full"> 
      {% if user.isCoordinator %}
        <div class="flex-container-space-between">
          <div>
            <h1 class="govuk-heading-xl govuk-!-margin-bottom-0">Use of force incident {{ data.incidentId }} </h1>
          </div>

          <div class="govuk-button-group govuk-!-margin-top-4">
              {{ govukButton({
                text: "Edit report",
                href: "edit-report",
                attributes: {'data-qa':'button-edit-report'}
              }) }}

              {{ govukButton({
                classes: "govuk-button--warning",
                text: "Delete incident",
                href: "delete-incident",
                attributes: {'data-qa':'button-delete-incident'}
              }) }}
          </div>
      </div>
      {% else %}
          <h1 class="govuk-heading-xl">Use of force incident {{ data.incidentId }}</h1>
      {% endif %}

      {{ mojSubNavigation({
        label: "Sub navigation",
        items: [{
          text: "Report",
          href: '/' + data.incidentId + '/view-report',
          attributes: { 'data-qa': 'report-tab' }
        }, {
          text: "Statements",
          active: true
        }]
      }) }}

      <table class="govuk-table" data-qa="statements" data-module="moj-sortable-table">
        <caption class="govuk-table__caption govuk-table__caption--m">Staff members involved</caption>
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="col" aria-sort="none">Name</th>
            <th class="govuk-table__header" scope="col" aria-sort="none">Location</th>
            <th class="govuk-table__header" scope="col" aria-sort="none">Email</th>
            <th class="govuk-table__header" scope="col" aria-sort="none">Status</th>
            <th class="govuk-table__header" scope="col">Action</th>
          </tr>
        </thead>

        <tbody class="govuk-table__body">
          {% for statement in data.statements %}
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">{{statement.name}} ({{statement.userId}})</td>
            <td class="govuk-table__cell"></td>
            <td class="govuk-table__cell">{{statement.email}}</td>
            <td class="govuk-table__cell">

              {% set removalRequested = statement.isRemovalRequested %}

              {% if removalRequested %}
                {{ 
                  removalRequestedBadge({
                    text: 'REMOVAL REQUEST', 
                    qa: 'removal-request' 
                  }) 
                }}     

              {% elif statement.isOverdue %}
                {{ 
                  overdueBadge({
                    text: 'OVERDUE', 
                    qa: 'overdue' 
                  }) 
                }}                  
              {% endif %}

              {% if not statement.isVerified and (removalRequested or statement.isOverdue) %}
              <span data-qa="unverified" class="moj-badge moj-badge--black govuk-!-margin-right-3">EMAIL NOT VERIFIED</span>
              {% elif not statement.isVerified %}
              <span data-qa="unverified" class="moj-badge moj-badge--black govuk-!-margin-right-3">EMAIL NOT VERIFIED</span>
              {% endif %}

            </td>

            <td class="govuk-table__cell">
              {% if statement.isSubmitted %}
                <a
                  href= {{ '/' + statement.id + '/view-statement' }}
                  draggable="false"
                  class="govuk-link">
                    View statement
                </a>

              {% elif removalRequested %}
                <a
                href= {{ '/coordinator/report/'+ data.incidentId +'/statement/' + statement.id + '/view-removal-request' }}  
                draggable="false"
                class="govuk-link float-right"
                data-qa="view-removal-request">
                View removal request
                </a>
              {% endif %}
            </td>
          </tr>  
          {% endfor %}
        </tbody>
      </table>

      <a
        href={{data.tab}}
        draggable="false"
        class="govuk-link"
        data-qa="return-link"
        >
        Return to use of force incidents
      </a>
    </div>
  </div>

  <div class="print"> 
    <!-- header -->
    <h1>Use of force incident number {{ data.incidentId }}</h1>
    <p>{{ reportDetail.reportHeading(data, true) }}</p>

    <!-- report body  -->
    <p>  {{ reportDetail.detail(reportDataForPrint, null, report.incidentId, user, true) }}</p>
  
    <!-- statement narrative and additional comments --> 
    <div class="page-break-before">
      {% for statement in statements %}
        <h2 class="govuk-heading-l">{{ statement.name }}'s statement</h2>
        <p> <span class="govuk-label--s"> Submitted: </span> {{statement.submittedDate | formatDate('D MMMM YYYY - HH:mm')}}</p>
        <p class="pre-wrapped">{{ statement.statement }}</p>
        {% for additionalComments in statement.additionalComments %}
          <hr/>
          <p> <span class="govuk-label--s"> Additional comment submitted: </span> {{additionalComments.dateSubmitted | formatDate('D MMMM YYYY - HH:mm')}}</p>
          <p class="pre-wrapped">{{ additionalComments.additionalComment}}</p>
        {% endfor %}
      <hr>
      {% endfor %}
    </div> 
  </div>
</div>
{% else %}
<div class="govuk-body">
  <div class="govuk-grid-row no-print">
    <div class="govuk-grid-column-full">
      <h1 class="govuk-heading-xl">{{ pageTitle }}</h1>
      <p class="govuk-!-padding-bottom-0">
        <a href="/{{ data.incidentId }}/view-report" draggable="false" class="govuk-link" data-qa="report-link">
          View report details
        </a>
      </p>
      <div class="flex-container-justified">
        <div class="flex-basis-60">
          {{ reportDetail.reportHeading(data) }}
        </div>
        <div class="float-right">
          <a href="#" class="govuk-link govuk-link--no-visited-state print-link">  Print report and statements  </a>
        </div>
      </div>
    </div>
    <div class="govuk-grid-column-two-thirds">
      <table class="govuk-table" data-qa="statements">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th class="govuk-table__header" scope="col">Staff members involved</th>
            <th class="govuk-table__header" scope="col"></th>
            <th class="govuk-table__header" scope="col"></th>
          </tr>
        </thead>
        <tbody class="govuk-table__body">
          {% for statement in data.statements %}
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">{{statement.name }}</td>
            <td class="govuk-table__cell">
              {% set removalRequested = statement.isRemovalRequested %}
              {% if removalRequested %}
                {{
                  removalRequestedBadge({
                    text: 'REMOVAL REQUEST',
                    qa: 'removal-request'
                  })
                }}
              {% elif statement.isOverdue %}
                {{
                  overdueBadge({
                    text: 'OVERDUE',
                    qa: 'overdue'
                  })
                }}
              {% endif %}
              {% if not statement.isVerified and (removalRequested or statement.isOverdue) %}
              <span data-qa="unverified" class="govuk-tag moj-tag--black govuk-!-margin-right-3 govuk-!-margin-top-1"></span>
              {% elif not statement.isVerified %}
              <span data-qa="unverified" class="govuk-tag moj-tag--black govuk-!-margin-right-3"></span>
              {% endif %}
            </td>
            <td class="govuk-table__cell">
              {% if statement.isSubmitted %}
                <a
                  href= {{ '/' + statement.id + '/view-statement' }}
                  draggable="false"
                  class="govuk-link float-right">
                    View statement
                </a>
              {% elif removalRequested %}
                <a
                href= {{ '/coordinator/report/'+ data.incidentId +'/statement/' + statement.id + '/view-removal-request' }}
                draggable="false"
                class="govuk-link float-right"
                data-qa="view-removal-request">
                View removal request
                </a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="govuk-!-margin-bottom-2">
        {% if user.isCoordinator %}
            <td class="govuk-table__cell">
                <a href="/coordinator/report/{{ data.incidentId }}/confirm-delete" class="govuk-link" data-qa='delete'> Delete incident </a>
            </td>
        {% endif %}
      </div>
      <a
        href={{data.tab}}
        draggable="false"
        class="govuk-link"
        data-qa="return-link"
        >
        Return to use of force incidents
      </a>
    </div>
  </div>
  <div class="print">
    <!-- header -->
    <h1>Use of force incident number {{ data.incidentId }}</h1>
    <p>{{ reportDetail.reportHeading(data, true) }}</p>
    <!-- report body  -->
    <p>  {{ reportDetail.detail(reportDataForPrint, null, report.incidentId, user, true) }}</p>
    <!-- statement narrative and additional comments -->
    <div class="page-break-before">
      {% for statement in statements %}
        <h2 class="govuk-heading-l">{{ statement.name }}'s statement</h2>
        <p> <span class="govuk-label--s"> Submitted: </span> {{statement.submittedDate | formatDate('D MMMM YYYY - HH:mm')}}</p>
        <p class="pre-wrapped">{{ statement.statement }}</p>
        {% for additionalComments in statement.additionalComments %}
          <hr/>
          <p> <span class="govuk-label--s"> Additional comment submitted: </span> {{additionalComments.dateSubmitted | formatDate('D MMMM YYYY - HH:mm')}}</p>
          <p class="pre-wrapped">{{ additionalComments.additionalComment}}</p>
        {% endfor %}
      <hr>
      {% endfor %}
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

